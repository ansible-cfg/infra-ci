#!/bin/sh
# {{ ansible_managed }}
{% set merged = v4_default_rules.copy() %}
{% set _ = merged.update(v4_group_rules) %}
{% set _ = merged.update(v4_host_rules) %}

# flush rules & delete user-defined chains
iptables -F DOCKER-USER
#iptables -X
#iptables -t raw -F
#iptables -t raw -X
#iptables -t nat -F
#iptables -t nat -X
#iptables -t mangle -F
#iptables -t mangle -X

{%- for port in public_ports %}
iptables -A DOCKER-USER -s 0.0.0.0/0 -p {{ port.protocol }} --dport {{ port.port }} -i eth0 -j ACCEPT
{%- endfor %}

{% for network, host in privatenetwork.iteritems() %}
  iptables -A DOCKER-USER -s {{ host.ipv4 }}/32 -d 0.0.0.0/0 -i eth0 -o docker0 -j ACCEPT
{% endfor %}
iptables -A DOCKER-USER -i eth0 -o docker0 -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
iptables -A INPUT -i eth0 -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT

iptabls -A DOCKER-USER -s 172.17.0.0/12 -j ACCEPT

iptables -A INPUT -p tcp --dport 22 -j ACCEPT

iptables -A DOCKER-USER -s 0.0.0.0/0 -j DROP
