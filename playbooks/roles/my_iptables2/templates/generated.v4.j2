#!/bin/sh
# {{ ansible_managed }}
{% set merged = v4_default_rules.copy() %}
{% set _ = merged.update(v4_group_rules) %}
{% set _ = merged.update(v4_host_rules) %}

# flush rules & delete user-defined chains
iptables -N BEFORE-DOCKER

iptables -F BEFORE-DOCKER
iptables -F DOCKER-USER
#iptables -X
#iptables -t raw -F
#iptables -t raw -X
#iptables -t nat -F
#iptables -t nat -X
#iptables -t mangle -F
#iptables -t mangle -X


{% for port in public_ports %}
iptables -A DOCKER-USER -s 0.0.0.0/0 -p {{ port.protocol }} --dport {{ port.port }} -j ACCEPT
iptables -A BEFORE-DOCKER -s 0.0.0.0/0 -p {{ port.protocol }} --dport {{ port.port }} -j ACCEPT
{% endfor %}

{% for network, host in privatenetwork.iteritems() %}
iptables -A DOCKER-USER -s {{ host.ipv4 }} -d 172.16.0.0/12 -i eth0 -o docker0 -j ACCEPT
iptables -A BEFORE-DOCKER -s {{ host.ipv4 }} -d 0.0.0.0/0 -j ACCEPT
{% endfor %}

iptables -A DOCKER-USER -i eth0 -o docker0 -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT

iptables -A DOCKER-USER -s 172.16.0.0/12 -d 0.0.0.0/0 -j ACCEPT

iptables -A DOCKER-USER -s 0.0.0.0/0 -j DROP
